---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Hero from '../components/Hero.astro';
import ReviewCard from '../components/ReviewCard.astro';
import { getAllLocations, getAllBlogPosts, getSiteConfig } from '../lib/sanity-utils';
import { urlFor } from '../lib/sanity';

export async function getStaticPaths() {
  const locations = await getAllLocations();
  
  return locations.map((location) => ({
    params: { location: location.slug.current },
    props: { location }
  }));
}

const { location } = Astro.props;
const allCafes = await getAllBlogPosts();

// Filter cafes for this location
const locationCafes = allCafes.filter(cafe => 
  cafe.location?.slug === location.slug.current
);

let siteTitle = 'Cafe Reviews';
let siteDescription = 'Discovering the perfect cup, one cafe at a time';

try {
  const siteConfig = await getSiteConfig();
  if (siteConfig) {
    siteTitle = siteConfig.title || siteTitle;
    siteDescription = siteConfig.description || siteDescription;
  }
} catch (error) {
  console.error('Failed to load site config for meta tags:', error);
}

const pageTitle = `${location.cityName} Cafes - ${siteTitle}`;
const pageDescription = location.description || `Discover the best cafes in ${location.cityName}`;

// Get all banner images from bannerImages array
const bannerImageUrls = location.bannerImages?.map(image => 
  urlFor(image).width(1920).height(1080).url()
) || [];
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
  </head>
  <body>
    <main class="homepage-main">
      <Hero cityName={location.cityName} bannerImageUrls={bannerImageUrls} showScrollIndicator={true} />
      
      <section class="location-reviews">
        <div class="container">
          {location.description && (
            <div class="section-header">
              <p class="location-description">{location.description}</p>
            </div>
          )}
          
          {locationCafes.length > 0 && (
            <div class="sort-controls">
              <label for="sort-by">Sort by:</label>
              <select id="sort-by" class="sort-dropdown">
                <option value="newest">Newest</option>
                <option value="vegan">Vegan Options</option>
                <option value="glutenFree">Gluten Free</option>
                <option value="workability">Workability</option>
                <option value="coffee">Coffee Craftsmanship</option>
                <option value="health">Health Focus</option>
                <option value="croissants">Croissants</option>
              </select>
            </div>
          )}

          {locationCafes.length > 0 ? (
            <div class="reviews-grid" id="reviews-grid">
              {locationCafes.map((cafe) => (
                <div 
                  class="review-item"
                  data-vegan={cafe.veganOptions || 0}
                  data-gluten-free={cafe.glutenFree || 0}
                  data-workability={cafe.workability || 0}
                  data-coffee={cafe.coffeeCraftsmanship || 0}
                  data-health={cafe.healthFocus || 0}
                  data-croissants={cafe.croissants || 0}
                  data-date={cafe.pubDate.getTime()}
                >
                  <ReviewCard
                    title={cafe.title}
                    slug={cafe.slug}
                    description={cafe.description}
                    heroImage={cafe.heroImage}
                    rating={cafe.rating}
                    location={cafe.location}
                    hideLocation={true}
                    veganOptions={cafe.veganOptions}
                    glutenFree={cafe.glutenFree}
                    workability={cafe.workability}
                    coffeeCraftsmanship={cafe.coffeeCraftsmanship}
                    healthFocus={cafe.healthFocus}
                    croissants={cafe.croissants}
                  />
                </div>
              ))}
            </div>
          ) : (
            <div class="no-reviews">
              <p>No reviews available for {location.cityName} yet. Check back soon!</p>
            </div>
          )}
        </div>
      </section>
    </main>
    <Footer />
    
    <script>
      const sortDropdown = document.getElementById('sort-by') as HTMLSelectElement;
      const reviewsGrid = document.getElementById('reviews-grid');
      
      if (sortDropdown && reviewsGrid) {
        sortDropdown.addEventListener('change', () => {
          const sortBy = sortDropdown.value;
          const items = Array.from(reviewsGrid.children) as HTMLElement[];
          
          items.sort((a, b) => {
            let aValue: number, bValue: number;
            
            switch(sortBy) {
              case 'vegan':
                aValue = parseFloat(a.dataset.vegan || '0');
                bValue = parseFloat(b.dataset.vegan || '0');
                break;
              case 'glutenFree':
                aValue = parseFloat(a.dataset.glutenFree || '0');
                bValue = parseFloat(b.dataset.glutenFree || '0');
                break;
              case 'workability':
                aValue = parseFloat(a.dataset.workability || '0');
                bValue = parseFloat(b.dataset.workability || '0');
                break;
              case 'coffee':
                aValue = parseFloat(a.dataset.coffee || '0');
                bValue = parseFloat(b.dataset.coffee || '0');
                break;
              case 'health':
                aValue = parseFloat(a.dataset.health || '0');
                bValue = parseFloat(b.dataset.health || '0');
                break;
              case 'croissants':
                aValue = parseFloat(a.dataset.croissants || '0');
                bValue = parseFloat(b.dataset.croissants || '0');
                break;
              case 'newest':
              default:
                aValue = parseFloat(a.dataset.date || '0');
                bValue = parseFloat(b.dataset.date || '0');
                break;
            }
            
            // Sort descending (highest first)
            return bValue - aValue;
          });
          
          // Reorder the DOM elements
          items.forEach(item => reviewsGrid.appendChild(item));
        });
      }
    </script>
  </body>
</html>

<style>
  .homepage-main {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }

  .location-reviews {
    padding: 4rem 0;
    background: #fafafa;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .section-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .sort-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .sort-controls label {
    font-weight: 600;
    color: #333;
  }

  .sort-dropdown {
    padding: 0.5rem 1rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    font-size: 1rem;
    color: #333;
    cursor: pointer;
    transition: border-color 0.3s ease;
  }

  .sort-dropdown:hover {
    border-color: #ff6b35;
  }

  .sort-dropdown:focus {
    outline: none;
    border-color: #ff6b35;
  }

  .section-header h2 {
    font-size: 2.5rem;
    color: #333;
    margin: 0 0 1rem 0;
    font-weight: 700;
  }

  .location-description {
    font-size: 1.1rem;
    color: #666;
    margin: 0 0 1rem 0;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }


  .reviews-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .no-reviews {
    text-align: center;
    padding: 3rem;
    color: #666;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .location-reviews {
      padding: 3rem 0;
    }

    .container {
      padding: 0 1rem;
    }

    .reviews-grid {
      gap: 1.25rem;
    }

    .section-header h2 {
      font-size: 2rem;
    }
  }
</style>
